import Head from 'next/head'
import Link from 'next/link';
import { useEffect, useState } from 'react';
import { FaPencilAlt, FaPlus, FaTrashAlt} from 'react-icons/fa'
import styles from '../styles/Home.module.css'
import { client, DELETE_DATA, FILTER_DATA, QUERY_COUNTRIES } from '../lib/utils';
import Filter from '../components/Filter';

export default function Home({listCountries}) {
  const [countries, setCountries] = useState([]);
  const [selection, setSelection] = useState('All');
  useEffect(() =>{
    const fetchCountries = async () => {
    const {data} = await client.query(
      {
        query: FILTER_DATA,
        variables: {
          country: selection
        }
      })
      console.log(data)
      setCountries(data.filterCountries)
    }
    fetchCountries()
  }, [selection, countries])

  const handleDelete = (id) => {
    try {
      const {data} = client.mutate(
        {
          mutation:DELETE_DATA,
          variables: {
            id
          }
        })
        console.log(data)
    } catch (error) {
      console.log(error.runTimeError.result.errors)
    }
  }
  return (
    <div className={styles.container}>
      <Head>
        <title>Stats App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

    <main>
      <Filter countries={listCountries} setSelection={setSelection} />
      <h1 className="text-center mb-4 text-2xl my-3">Demographic and Social Statistics</h1>
      <div className="flex gap-5 flex-wrap mb-8 justify-center">
      {
        countries.map(({id, Country, Area, Year, Total}) => (
          <div key={id} className="border w-96 h-60 p-5 shadow group">
            <h2 className=" text-lg font-bold text-center pb-2">{Country}</h2>
            <hr />
            <div className="p-4 text-center">
              <p><span className="font-semibold">Year</span>: {Year}</p>
              <p><span className="font-semibold">Population:</span> {Total}</p>
              <p><span className="font-semibold">Area:</span> {Area} km&sup2;</p>
            </div>

            <div className="hidden group-hover:block mb-0">
              <hr />
              <div className="flex justify-between pt-4">
                <Link href={`/data/${id}`}>
                  <a rel="noopener noreferrer" className="border w-32 p-1 rounded-md bg-teal-200 cursor-pointer hover:bg-teal-400 hover:text-white">
                    <FaPencilAlt className="m-auto " />
                  </a>
                </Link>
                <button
                  className="border w-32 p-1 rounded-md bg-red-400 cursor-pointer hover:bg-red-500 hover:text-white"
                  onClick={() => handleDelete(id)}
                  >
                    <FaTrashAlt className="m-auto" />
                  </button>
              </div>
            </div>
          </div>
        ))
      }
      </div>
    </main>
    </div>
  )
}

export async function getStaticProps() {
  const {data} = await client.query({query: QUERY_COUNTRIES})
  return {
    props: {
      listCountries: data.countries
    }
  }
}
